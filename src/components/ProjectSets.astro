---
import { frontmatter as projectData } from '../content/Projects.md'
import { imagePath } from '../settings/siteInfo'
import Project from './Project.svelte'
import getDimsFromImageUrls from '../scripts/getDimsFromImageUrls.js'

// Set max width for stills, to be used to calculate max heights
const maxStillWidth = 1980

const getProjectWithImageDimsData = async (project) => {
  // Get stills URLs
  const urls = project.stills.map(still => imagePath + still)

  // Add featured still URL (probably always an image from the standard stills,
  // but include it here separately in case it's not)
  urls.push(imagePath + project.featuredStill)

  // Get dims and aspect ratio for all images
  const stillsDimsSansMaxDims = await getDimsFromImageUrls(urls)
  const stillsDimsWithMaxDims = 
    stillsDimsSansMaxDims.map(({ width, height, aspect }) => {
      return {
        width,
        height,
        aspect,
        maxWidth: maxStillWidth,
        maxHeight: Math.round(maxStillWidth / aspect)
      }
    })

  return {
    ...project,
    stillsDims: stillsDimsWithMaxDims.slice(0, -1), // remove featured still
    featuredStillDims: stillsDimsSansMaxDims.slice(-1)[0]
  }
}
---

{projectData.projectSets.map((projectSet, i) => (
  <section class="section" id={i === 0 && 'first-section'}>
    <h3>{projectSet.heading}</h3>

    {projectSet.projects.map(async (project) => (
      <Project
        project={await getProjectWithImageDimsData(project)}
        projectTypeLabel={ 
          project.projectType ||
          projectSet.fallbackProjectTypeLabel
        }
        client:load
      />
    ))}
  </section>
))}